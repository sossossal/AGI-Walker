# Hive-Reflex

基于 IMC-22 的模块化脊髓反射控制器 - 分布式感知、本地反射、指令叠加。

## 📋 项目简介

Hive-Reflex 是一个创新的机器人关节控制系统，模仿生物脊髓反射机制，在每个关节节点本地运行轻量级神经网络，实现快速响应和柔顺控制。

**核心特性:**
- 🧠 **边缘智能**: 运行在 IMC-22 (RISC-V + 神经加速器) 上的极简 LSTM 网络
- ⚡ **超低延迟**: 1kHz 控制频率，推理时间 < 50μs
- 🔄 **混合控制**: PID + 神经反射的动态叠加，可调柔顺度
- 🛡️ **安全机制**: 通信超时检测，自动进入安全模式
- 📡 **分布式架构**: CAN-FD 总线，支持热插拔和时间同步

## 🗂️ 文件结构

```
hive-reflex/
├── hive_arch.md           # 架构设计文档
├── hive_node_ctrl.c       # 嵌入式控制代码 (C)
├── reflex_net.py          # 神经网络定义和导出
├── train_reflex_net.py    # 训练脚本模板
├── simulator.py           # 关节物理仿真器
└── README.md              # 本文件
```

## 🚀 快速开始

### 1. 导出神经网络模型

```bash
# 导出 FP32 模型
python reflex_net.py

# 导出 INT8 量化模型 (推荐用于 IMC-22)
python reflex_net.py --quantize
```

### 2. 运行仿真验证

```bash
# 安装依赖
pip install numpy matplotlib torch

# 运行仿真器
python simulator.py
```

仿真将对比不同柔顺系数 (γ) 下的控制效果，并生成 `simulation_result.png`。

### 3. 训练自定义反射模型

```bash
# 使用虚拟数据训练 (仅用于测试)
python train_reflex_net.py

# 实际部署前需替换为真实硬件数据
```

## 🧮 控制原理

系统采用 **指令叠加** 控制律:

$$U_{\text{final}} = U_{\text{PID}} \cdot (1 - \gamma) + f_{\text{NN}}(S_{\text{local}}) \cdot \gamma \cdot T_{\text{max}}$$

- **γ = 0** (刚性模式): 纯 PID 控制，适用于精确轨迹跟踪
- **γ = 0.5** (混合模式): 平衡精度与柔顺性
- **γ = 1** (柔顺模式): 纯反射控制，适用于动态环境交互

## 📊 性能指标

| 指标 | 数值 |
|------|------|
| 控制频率 | 1 kHz (1ms) |
| 模型参数量 | ~2.5K (FP32) / ~650 (INT8) |
| 内存占用 | 10 KB (FP32) / 2.5 KB (INT8) |
| 推理延迟 | < 50 μs (理论值) |
| CAN 总线速率 | 5 Mbps (CAN-FD) |

## 🛠️ 优化记录

**v0.2 (当前版本) - 2026-01-16**
- ✅ 修复 LSTM 隐藏状态持久化问题
- ✅ 改进柔顺性参数语义 (stiffness → compliance)
- ✅ 添加通信超时检测和安全模式
- ✅ 支持 INT8 量化导出
- ✅ 优化 CAN 协议 (使用定点数压缩)
- ✅ 提供仿真器和训练脚本模板

**v0.1 (初始概念)**
- 基础架构设计
- ReflexNet 神经网络定义
- CAN 通信协议规范

## 📖 详细文档

- **架构设计**: 查看 [`hive_arch.md`](hive_arch.md)
- **硬件要求**: IMC-22 (RISC-V + Neural Accelerator), 512KB SRAM
- **通信协议**: CAN-FD (详见架构文档第 4 节)

## ⚠️ 注意事项

1. **C 代码中的 lint 错误**: 由于缺少硬件驱动头文件 (`can_protocol.h`, `imc_driver.h`)，IDE 会报错。这些文件由硬件厂商提供，实际编译时需链接。

2. **训练数据**: 当前训练脚本使用虚拟数据。实际部署前需：
   - 在真实硬件上记录传感器数据
   - 使用专家演示或最优控制轨迹标注

3. **量化精度**: INT8 量化可能导致 1-2% 的精度损失，建议使用 **量化感知训练 (QAT)** 获得最佳效果。

## 🔮 未来方向

- [ ] 实现多节点协同反射 (邻居状态共享)
- [ ] 自适应柔顺度调节 (神经网络输出 γ)
- [ ] 支持更多传感器 (压力、触觉)
- [ ] 在线学习和参数微调

## 📄 许可证

本项目为概念验证代码，仅供研究和学习使用。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

**作者**: Hive-Reflex Team  
**最后更新**: 2026-01-16
