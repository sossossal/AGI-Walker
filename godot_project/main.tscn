[gd_scene load_steps=16 format=3 uid="uid://dh72x5mxlhvmb"]

[ext_resource type="Script" uid="uid://dqm5rd8kqfqoc" path="res://balance_controller.gd" id="2_0xm2m"]
[ext_resource type="Script" uid="uid://sojkxeftk1mw" path="res://scripts/tcp_server.gd" id="2_h2yge"]

[sub_resource type="BoxShape3D" id="BoxShape3D_1bvp3"]
size = Vector3(20, 0.5, 20)

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_lquwl"]
albedo_color = Color(0.6734458, 0.62347275, 0.63633126, 1)

[sub_resource type="BoxMesh" id="BoxMesh_7mycd"]
material = SubResource("StandardMaterial3D_lquwl")
size = Vector3(20, 0.5, 20)

[sub_resource type="GDScript" id="GDScript_ig7tw"]
script/source = "extends Node3D
## ç®€å•ç›’å­æœºå™¨äºº
## åŒ…å«èº¯å¹²å’Œä¸¤æ¡è…¿ï¼Œä½¿ç”¨HingeJointè¿æ¥

# æœºå™¨äººç»„ä»¶å¼•ç”¨
@onready var torso: RigidBody3D = $Torso
@onready var left_leg: RigidBody3D = $LeftLeg
@onready var right_leg: RigidBody3D = $RightLeg
@onready var hip_left: HingeJoint3D = $HipLeft
@onready var hip_right: HingeJoint3D = $HipRight

# å…³èŠ‚è§’åº¦å­˜å‚¨ï¼ˆç”¨äºä¼ æ„Ÿå™¨ï¼‰
var joint_angles := {
	\"hip_left\": 0.0,
	\"hip_right\": 0.0
}

# å…³èŠ‚ç›®æ ‡è§’åº¦ï¼ˆæ¥è‡ªAIæ§åˆ¶ï¼‰
var target_angles := {
	\"hip_left\": 0.0,
	\"hip_right\": 0.0
}

# ç”µæœºå‚æ•°
const MOTOR_FORCE = 500.0 # æ‰­çŸ©å¤§å°
const MOTOR_SPEED = 5.0 # å“åº”é€Ÿåº¦


func _ready():
	print(\"ğŸ¤– ç›’å­æœºå™¨äººå·²åˆå§‹åŒ–\")
	_setup_motors()


func _setup_motors():
	\"\"\"é…ç½®å…³èŠ‚ç”µæœº\"\"\"
	# å·¦é«‹å…³èŠ‚
	hip_left.set_flag(HingeJoint3D.FLAG_ENABLE_MOTOR, true)
	hip_left.set_param(HingeJoint3D.PARAM_MOTOR_MAX_IMPULSE, MOTOR_FORCE)
	
	# å³é«‹å…³èŠ‚
	hip_right.set_flag(HingeJoint3D.FLAG_ENABLE_MOTOR, true)
	hip_right.set_param(HingeJoint3D.PARAM_MOTOR_MAX_IMPULSE, MOTOR_FORCE)


func _physics_process(delta):
	\"\"\"ç‰©ç†æ­¥è¿› - æ›´æ–°ç”µæœºæ§åˆ¶\"\"\"
	_update_motors(delta)
	_update_joint_angles()


func _update_motors(_delta):
	\"\"\"æ ¹æ®ç›®æ ‡è§’åº¦æ›´æ–°ç”µæœº\"\"\"
	# å·¦é«‹
	var left_error = target_angles[\"hip_left\"] - joint_angles[\"hip_left\"]
	var left_velocity = left_error * MOTOR_SPEED
	hip_left.set_param(HingeJoint3D.PARAM_MOTOR_TARGET_VELOCITY, left_velocity)
	
	# å³é«‹
	var right_error = target_angles[\"hip_right\"] - joint_angles[\"hip_right\"]
	var right_velocity = right_error * MOTOR_SPEED
	hip_right.set_param(HingeJoint3D.PARAM_MOTOR_TARGET_VELOCITY, right_velocity)


func _update_joint_angles():
	\"\"\"æ›´æ–°å…³èŠ‚è§’åº¦ï¼ˆä»ç‰©ç†å¼•æ“è¯»å–ï¼‰\"\"\"
	# æ³¨æ„: Godotçš„HingeJointæ²¡æœ‰ç›´æ¥è·å–è§’åº¦çš„API
	# è¿™é‡Œä½¿ç”¨è¿‘ä¼¼æ–¹æ³•ï¼šé€šè¿‡åˆšä½“çš„ç›¸å¯¹æ—‹è½¬è®¡ç®—
	
	# å·¦è…¿ç›¸å¯¹èº¯å¹²çš„æ—‹è½¬
	var left_relative = torso.global_transform.basis.inverse() * left_leg.global_transform.basis
	joint_angles[\"hip_left\"] = rad_to_deg(left_relative.get_euler().z)
	
	# å³è…¿ç›¸å¯¹èº¯å¹²çš„æ—‹è½¬
	var right_relative = torso.global_transform.basis.inverse() * right_leg.global_transform.basis
	joint_angles[\"hip_right\"] = rad_to_deg(right_relative.get_euler().z)


func get_sensor_data() -> Dictionary:
	\"\"\"æ”¶é›†æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ®\"\"\"
	return {
		\"timestamp\": Time.get_ticks_msec() / 1000.0,
		\"sensors\": {
			\"imu\": _get_imu_data(),
			\"joints\": _get_joint_data(),
			\"contacts\": _get_contact_data()
		},
		\"torso_height\": torso.global_position.y
	}


func _get_imu_data() -> Dictionary:
	\"\"\"IMUä¼ æ„Ÿå™¨æ•°æ®ï¼ˆåŠ é€Ÿåº¦ã€é™€èºä»ªã€å§¿æ€ï¼‰\"\"\"
	var euler = torso.global_transform.basis.get_euler()
	
	return {
		\"accel\": [
			torso.linear_velocity.x,
			torso.linear_velocity.y - 9.8, # å‡å»é‡åŠ›
			torso.linear_velocity.z
		],
		\"gyro\": [
			torso.angular_velocity.x,
			torso.angular_velocity.y,
			torso.angular_velocity.z
		],
		\"orient\": [
			rad_to_deg(euler.x), # roll
			rad_to_deg(euler.y), # pitch
			rad_to_deg(euler.z) # yaw
		]
	}


func _get_joint_data() -> Dictionary:
	\"\"\"å…³èŠ‚ä½ç½®å’Œé€Ÿåº¦æ•°æ®\"\"\"
	return {
		\"hip_left\": {
			\"angle\": joint_angles[\"hip_left\"],
			\"velocity\": 0.0 # TODO: é€šè¿‡å·®åˆ†è®¡ç®—
		},
		\"hip_right\": {
			\"angle\": joint_angles[\"hip_right\"],
			\"velocity\": 0.0
		}
	}


func _get_contact_data() -> Dictionary:
	\"\"\"æ¥è§¦ä¼ æ„Ÿå™¨æ•°æ®\"\"\"
	# ç®€åŒ–ç‰ˆæœ¬ï¼šé€šè¿‡æ£€æµ‹è„šçš„é«˜åº¦åˆ¤æ–­æ˜¯å¦æ¥åœ°
	var left_foot_pos = left_leg.global_position
	var right_foot_pos = right_leg.global_position
	
	return {
		\"foot_left\": left_foot_pos.y < 0.3, # æ¥è¿‘åœ°é¢
		\"foot_right\": right_foot_pos.y < 0.3
	}


func apply_motor_commands(command: Dictionary):
	\"\"\"åº”ç”¨æ¥è‡ªAIçš„ç”µæœºæŒ‡ä»¤\"\"\"
	if command.has(\"motors\"):
		var motors = command[\"motors\"]
		
		if motors.has(\"hip_left\"):
			target_angles[\"hip_left\"] = clamp(motors[\"hip_left\"], -45, 90)
		
		if motors.has(\"hip_right\"):
			target_angles[\"hip_right\"] = clamp(motors[\"hip_right\"], -45, 90)


func reset_pose():
	\"\"\"é‡ç½®æœºå™¨äººåˆ°åˆå§‹å§¿æ€\"\"\"
	target_angles[\"hip_left\"] = 0.0
	target_angles[\"hip_right\"] = 0.0
	
	# é‡ç½®ç‰©ç†çŠ¶æ€
	torso.linear_velocity = Vector3.ZERO
	torso.angular_velocity = Vector3.ZERO
	left_leg.linear_velocity = Vector3.ZERO
	right_leg.linear_velocity = Vector3.ZERO
"

[sub_resource type="BoxShape3D" id="BoxShape3D_272bh"]
size = Vector3(0.5, 1, 0.3)

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_5vw27"]
albedo_color = Color(0.41639635, 0.6572853, 0.9315847, 1)

[sub_resource type="BoxMesh" id="BoxMesh_kek77"]
material = SubResource("StandardMaterial3D_5vw27")
size = Vector3(0.5, 1, 0.3)

[sub_resource type="BoxShape3D" id="BoxShape3D_4c57u"]
size = Vector3(0.2, 0.8, 0.2)

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_efxa6"]
albedo_color = Color(0.2978277, 0.6224538, 0.920285, 1)

[sub_resource type="BoxMesh" id="BoxMesh_dg77c"]
material = SubResource("StandardMaterial3D_efxa6")
size = Vector3(0.2, 0.8, 0.2)

[sub_resource type="BoxShape3D" id="BoxShape3D_ycdy4"]
size = Vector3(0.2, 0.8, 0.2)

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_w48qg"]
albedo_color = Color(0.2919485, 0.8229274, 0.9010054, 1)

[sub_resource type="BoxMesh" id="BoxMesh_vivmo"]
material = SubResource("StandardMaterial3D_w48qg")
size = Vector3(0.2, 0.8, 0.2)

[node name="main" type="Node3D"]

[node name="Ground" type="StaticBody3D" parent="."]

[node name="CollisionPolygon3D" type="CollisionShape3D" parent="Ground"]
shape = SubResource("BoxShape3D_1bvp3")

[node name="MeshInstance3D" type="MeshInstance3D" parent="Ground"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.43414545, 0.15717506, -0.27328825)
mesh = SubResource("BoxMesh_7mycd")

[node name="robot" type="Node3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1.5, 0)
script = SubResource("GDScript_ig7tw")

[node name="Torso" type="RigidBody3D" parent="robot"]
mass = 10.0

[node name="CollisionShape3D" type="CollisionShape3D" parent="robot/Torso"]
shape = SubResource("BoxShape3D_272bh")

[node name="MeshInstance3D" type="MeshInstance3D" parent="robot/Torso/CollisionShape3D"]
mesh = SubResource("BoxMesh_kek77")

[node name="LeftLeg" type="RigidBody3D" parent="robot"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.3, -0.5, 0)
mass = 2.0

[node name="CollisionShape3D" type="CollisionShape3D" parent="robot/LeftLeg"]
shape = SubResource("BoxShape3D_4c57u")

[node name="MeshInstance3D" type="MeshInstance3D" parent="robot/LeftLeg"]
mesh = SubResource("BoxMesh_dg77c")

[node name="RightLeg" type="RigidBody3D" parent="robot"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.3, -0.5, 0)
mass = 2.0

[node name="CollisionShape3D" type="CollisionShape3D" parent="robot/RightLeg"]
shape = SubResource("BoxShape3D_ycdy4")

[node name="MeshInstance3D" type="MeshInstance3D" parent="robot/RightLeg"]
mesh = SubResource("BoxMesh_vivmo")

[node name="HipLeft" type="HingeJoint3D" parent="robot"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.25, 0, 0)
node_a = NodePath("../Torso")
node_b = NodePath("../LeftLeg")
angular_limit/enable = true
angular_limit/lower = -0.7853982
motor/enable = true
motor/target_velocity = 0.0
motor/max_impulse = 1000.0

[node name="HipRight" type="HingeJoint3D" parent="robot"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.25, 0, 0)
node_a = NodePath("../Torso")
node_b = NodePath("../RightLeg")
angular_limit/enable = true
angular_limit/lower = -0.7853982
motor/enable = true
motor/target_velocity = 0.0
motor/max_impulse = 1000.0

[node name="Camera3D" type="Camera3D" parent="."]
transform = Transform3D(0.48022354, -0.45045075, 0.7526483, 0, 0.8580649, 0.5135413, -0.8771461, -0.2466146, 0.41206294, 4.9872656, 2.28529, 5.4109125)

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="."]
transform = Transform3D(0.8660254, -0.35355338, 0.35355338, 0, 0.70710677, 0.70710677, -0.5, -0.6123724, 0.6123724, 0, 0, 0)

[node name="TCPServer" type="Node" parent="."]
script = ExtResource("2_h2yge")

[node name="BalanceController" type="Node" parent="."]
script = ExtResource("2_0xm2m")
